---
title: 注意事項とベストプラクティス
sidebar_position: 2
description: "Weaviate の Python クライアントにおけるベストプラクティス、最適化のヒント、おすすめ実装パターンです。"
image: og/docs/client-libraries.jpg
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import FilteredTextBlock from '@site/src/components/Documentation/FilteredTextBlock';
import PythonCode from '!!raw-loader!/_includes/code/client-libraries/python_v4.py';
import BatchVectorCode from '!!raw-loader!/_includes/code/howto/manage-data.import.py';

## クライアントの生成

Weaviate インスタンスへ接続する方法はいくつかあります。クライアントを生成するには、次のいずれかの方法を使用します。

- [接続ヘルパー関数](#connection-helper-functions)
- [明示的な生成](#explicit-instantiation)

### 接続ヘルパー関数

- `weaviate.connect_to_weaviate_cloud()`
    - 以前は `connect_to_wcs()` です
- `weaviate.connect_to_local()`
- `weaviate.connect_to_embedded()`
- `weaviate.connect_to_custom()`

<Tabs groupId="languages">
<TabItem value="wcd" label="WCD">

<FilteredTextBlock
  text={PythonCode}
  startMarker="# WCDInstantiation"
  endMarker="# END WCDInstantiation"
  language="py"
/>

</TabItem>
<TabItem value="local" label="Local">

  <FilteredTextBlock
    text={PythonCode}
    startMarker="# LocalInstantiationBasic"
    endMarker="# END LocalInstantiationBasic"
    language="py"
  />

</TabItem>
<TabItem value="embedded" label="Embedded">

<FilteredTextBlock
  text={PythonCode}
  startMarker="# EmbeddedInstantiationBasic"
  endMarker="# END EmbeddedInstantiationBasic"
  language="py"
/>

</TabItem>
<TabItem value="custom" label="Custom">

<FilteredTextBlock
  text={PythonCode}
  startMarker="# CustomInstantiationBasic"
  endMarker="# END CustomInstantiationBasic"
  language="py"
/>

</TabItem>
</Tabs>

`v4` クライアントのヘルパー関数では、クライアントをカスタマイズするためのオプションパラメーターを指定できます。

- [外部 API キーを指定](#external-api-keys)
- [タイムアウト値を指定](#timeout-values)
- [認証情報を指定](#authentication)

#### 外部 API キー

Cohere や OpenAI などのサービス向け API キーを追加するには、`headers` パラメーターを使用します。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# LocalInstantiationWithHeaders"
  endMarker="# END LocalInstantiationWithHeaders"
  language="py"
/>

#### タイムアウト値

クライアントのタイムアウト値（秒）を設定できます。`Timeout` クラスを使用して、初期化チェックやクエリ、挿入操作のタイムアウト値を構成します。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# LocalWithTimeout"
  endMarker="# END LocalWithTimeout"
  language="py"
/>

:::tip `generate` クエリのタイムアウト

`generate` サブモジュールを使用している際にエラーが発生した場合は、クエリのタイムアウト値（`Timeout(query=60)`）を増やしてみてください。 <br/><br/>`generate` サブモジュールでは、大規模言語モデルを使ってテキストを生成します。このサブモジュールは、言語モデルやその API の速度に依存します。 <br/><br/>タイムアウト値を増やすことで、言語モデルからの応答をクライアントがより長く待機できるようになります。
:::

#### 認証

一部の `connect` ヘルパー関数は認証情報を受け取ります。たとえば、`connect_to_weaviate_cloud` は WCD API キーまたは OIDC 認証情報を受け付けます。

<Tabs groupId="languages">
<TabItem value="api_key" label="API Key">

  <FilteredTextBlock
    text={PythonCode}
    startMarker="# WCDInstantiation"
    endMarker="# END WCDInstantiation"
    language="py"
  />

</TabItem>
<TabItem value="oidc" label="OIDC Credentials">

<FilteredTextBlock
  text={PythonCode}
  startMarker="# WCDwOIDCInstantiation"
  endMarker="# END WCDwOIDCInstantiation"
  language="py"
/>

:::warning 

OIDC を使用した Weaviate Cloud （WCD）への接続は非推奨となっており、近い将来削除されます。代わりに API キー認証をご利用ください。

:::

</TabItem>
</Tabs>

Client Credentials フローによる OIDC 認証には、`AuthClientCredentials` クラスを使用します。

Refresh Token フローによる OIDC 認証には、`AuthBearerToken` クラスを使用します。

ヘルパー関数で必要なカスタマイズができない場合は、[`WeaviateClient`](#explicit-instantiation) クラスを使用してクライアントを生成してください。

### 明示的なインスタンス化

独自のパラメーターを渡す必要がある場合は、`weaviate.WeaviateClient` クラスを使用してクライアントをインスタンス化します。これはクライアントオブジェクトをインスタンス化する最も柔軟な方法です。

接続を直接インスタンス化した場合、サーバーへ接続するには `.connect()` メソッドを呼び出す必要があります。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# DirectInstantiationFull"
  endMarker="# END DirectInstantiationFull"
  language="py"
/>

### カスタム SSL 証明書の使用

Python クライアントは SSL 証明書の直接指定をサポートしていません。自己署名証明書（例: エンタープライズ環境）を使用する必要がある場合は、以下の 2 つの方法があります。

#### オプション 1: 証明書を基盤ライブラリに追加する

Weaviate クライアントライブラリが使用する `certifi` などの基盤ライブラリにカスタム SSL 証明書を追加できます。

#### オプション 2: 環境変数を設定する

または、環境変数 `GRPC_DEFAULT_SSL_ROOTS_FILE_PATH` と `SSL_CERT_FILE` に証明書ファイルのパスを設定します。インスタンス化時に `additional_config=AdditionalConfig(trust_env=True)` も指定してください。これを行わないと、クライアントライブラリは環境変数を使用しません。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START CustomSSLExample"
  endMarker="# END CustomSSLExample"
  language="py"
/>

## 初期接続チェック

Weaviate サーバーへ接続を確立する際、クライアントは一連のチェックを実行します。これらにはサーバーバージョンの確認や、REST と gRPC のポートが利用可能であるかの確認が含まれます。

これらのチェックをスキップするには `skip_init_checks` を `True` に設定します。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# LocalInstantiationSkipChecks"
  endMarker="# END LocalInstantiationSkipChecks"
  language="py"
/>

ほとんどの場合、`skip_init_checks` はデフォルト値の `False` のまま使用すべきです。ただし接続に問題がある場合、一時的に `skip_init_checks=True` とすることで役立つことがあります。

追加の接続設定については [タイムアウト値](#timeout-values) を参照してください。


## バッチインポート

`v4` クライアントには、バッチインポートを実行する 2 通りの方法があります。クライアントオブジェクトから直接行う方法と、コレクションオブジェクトから行う方法です。

単一のコレクションまたはテナントに対してバッチインポートを行う場合は、コレクションオブジェクトを使用することを推奨します。マルチテナンシー構成など複数のコレクションに渡ってオブジェクトをインポートする場合は、`client.batch` を使用する方が便利かもしれません。

### バッチサイズの設定

バッチング動作を設定する方法は 3 つあります。`dynamic`、`fixed_size`、`rate_limit` です。

| 方法 | 説明 | 使用する場面 |
| :-- | :-- | :-- |
| `dynamic` | バッチサイズと同時実行リクエスト数をインポート中にサーバー負荷に応じて動的に調整します。 | 推奨される開始点。 |
| `fixed_size` | ユーザーが指定した固定サイズのバッチサイズと同時実行リクエスト数を使用します。 | 固定パラメーターを指定したい場合。 |
| `rate_limit` | Weaviate へ送信されるオブジェクト数をレートリミットします（n_objects per minute で指定）。 | サードパーティのベクトライゼーション API のレートリミットを回避したい場合。 |

#### 使用方法

以下のようにコンテキストマネージャーを使用することを推奨します。

これらのメソッドは、各バッチごとに新しいコンテキストマネージャーを返します。`failed_objects` や `failed_references` など、あるバッチから返された属性は、後続の呼び出しには含まれません。

<Tabs groupId="languages">
<TabItem value="dynamic" label="Dynamic">

  <FilteredTextBlock
    text={PythonCode}
    startMarker="# START BatchDynamic"
    endMarker="# END BatchDynamic"
    language="py"
  />

</TabItem>
<TabItem value="fixedSize" label="Fixed Size">

  <FilteredTextBlock
    text={PythonCode}
    startMarker="# START BatchFixedSize"
    endMarker="# END BatchFixedSize"
    language="py"
  />

</TabItem>
<TabItem value="rateLimit" label="Rate limited">

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START BatchRateLimit"
  endMarker="# END BatchRateLimit"
  language="py"
/>

</TabItem>
</Tabs>

バッチ送信を担当するバックグラウンドスレッドがバッチ処理中に例外を発生させた場合、そのエラーはメインスレッドへ伝搬します。

### エラー処理

バッチインポート中に失敗したオブジェクトや参照は、後で取得できるように保存されます。さらに、失敗したオブジェクトおよび参照の累計数も保持されます。

カウンターはコンテキストマネージャー内で `batch.number_errors` から取得できます。

失敗したオブジェクトの一覧は `batch.failed_objects` から、失敗した参照の一覧は `batch.failed_references` から取得できます。

これらのリストは、バッチングプロセスを初期化するとリセットされる点に注意してください。新しいバッチインポートブロックを開始する前に、必ず取得してください。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START BatchErrorHandling"
  endMarker="# END BatchErrorHandling"
  language="py"
/>

### バッチ ベクトル化

:::info `v1.25` で追加
:::

import BatchVectorizationOverview from '/_includes/code/client-libraries/batch-import.mdx';

<BatchVectorizationOverview />

コレクションを作成する際に **ベクトライザー** を設定すると、クライアントは自動的にベクトル化を処理します。

<Tabs groupId="languages">
  <TabItem value="py" label="Create a client">
    <FilteredTextBlock
      text={BatchVectorCode}
      startMarker="# START BatchVectorClient"
      endMarker="# END BatchVectorClient"
      language="py"
    />
  </TabItem>
</Tabs>

ベクトル化設定を変更するには、クライアント オブジェクトを更新します。次の例では複数のベクトライザーを追加しています。

- **Cohere**: サービス API キーを設定し、リクエスト レートを設定します。  
- **OpenAI**: サービス API キーを設定し、ベース URL を設定します。  
- **VoyageAI**: サービス API キーを設定します。  

<Tabs groupId="languages">
  <TabItem value="py" label="Modify the client">
    <FilteredTextBlock
      text={BatchVectorCode}
      startMarker="# START BatchVectorizationClientModify"
      endMarker="# END BatchVectorizationClientModify"
      language="py"
    />
  </TabItem>
</Tabs>

## ヘルパー クラス

クライアント ライブラリは、多数の追加 Python クラスを提供しており、 IDE 補助や型ヒントを受けられます。次のように個別にインポートできます。

```
from weaviate.classes.config import Property, ConfigFactory
from weaviate.classes.data import DataObject
from weaviate.classes.query import Filter
```

ただし、すべてのクラスをまとめてインポートすると便利な場合もあります。ドキュメントでは両方の使用スタイルを紹介しています。

```
import weaviate.classes as wvc
```

探索しやすいように、クラスはサブモジュールに整理されています。

<details>
  <summary>サブモジュールの一覧を見る</summary>

| Module                       | Description（説明）                |
| ---------------------------- | ---------------------------------- |
| `weaviate.classes.config`    | コレクションの作成 / 変更          |
| `weaviate.classes.data`      | CUD 操作                           |
| `weaviate.classes.query`     | クエリ / 検索操作                  |
| `weaviate.classes.aggregate` | 集約操作                           |
| `weaviate.classes.generic`   | 汎用                               |
| `weaviate.classes.init`      | 初期化                             |
| `weaviate.classes.tenants`   | テナント                           |
| `weaviate.classes.batch`     | バッチ操作                         |

</details>

## 接続の終了

クライアント接続を必ず閉じる必要があります。`client.close()` を使用するか、コンテキスト マネージャを利用して自動で接続を閉じることができます。

### `client.close()` と `try` / `finally`

`try` ブロックが完了したとき（または例外が発生したとき）にクライアント接続を閉じます。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# TryFinallyExample"
  endMarker="# END TryFinallyExample"
  language="py"
/>

### コンテキスト マネージャ

`with` ブロックを抜けるとクライアント接続が閉じられます。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# ClientContextManagerExample"
  endMarker="# END ClientContextManagerExample"
  language="py"
/>

## 例外処理

クライアント ライブラリは、さまざまなエラー条件で例外を送出します。例えば次のようなものがあります。

- `weaviate.exceptions.WeaviateConnectionError` : 接続に失敗した場合  
- `weaviate.exceptions.WeaviateQueryError` : クエリに失敗した場合  
- `weaviate.exceptions.WeaviateBatchError` : バッチ操作に失敗した場合  
- `weaviate.exceptions.WeaviateClosedClientError` : 閉じたクライアントで操作した場合  

これらの例外はすべて `weaviate.exceptions.WeaviateBaseError` を継承しており、以下のようにこのベース クラスで捕捉できます。

<FilteredTextBlock
    text={PythonCode}
    startMarker="# START BrokenQueryExample"
    endMarker="# END BrokenQueryExample"
    language="py"
/>

クライアント ライブラリで送出される例外の定義は、[このモジュール](https://github.com/weaviate/weaviate-python-client/blob/main/weaviate/exceptions.py) を参照してください。

各メソッドで送出される可能性のある例外は、クライアント ライブラリの docstring でも確認できます。 Python の `help` 関数、 Jupyter ノートブックの `?` 演算子、または VSCode などの IDE のホバー ツールチップで閲覧可能です。

## スレッド セーフティ

Python クライアントは基本的にスレッド セーフとなるよう設計されていますが、`requests` ライブラリへ依存しているため完全なスレッド セーフティは保証されません。

将来的にこの点を改善する予定です。

:::warning Thread safety
当社クライアントのバッチング アルゴリズムはスレッド セーフではありません。 Python クライアントをマルチスレッド環境で使用する際は、円滑で予測可能な動作を確保するためにご留意ください。
:::

マルチスレッド シナリオでバッチングを行う場合、任意の時点でバッチング ワークフローを実行するスレッドは 1 つだけにしてください。2 つ以上のスレッドが同時に同じ `client.batch` オブジェクトを使用することはできません。

## レスポンスオブジェクト構造

各クエリのレスポンスオブジェクトには、通常複数の属性が含まれます。次のクエリを確認してください。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START ResultDisplayExample"
  endMarker="# END ResultDisplayExample"
  language="py"
/>

各レスポンスには `objects` や `generated` などの属性が含まれます。そして、`objects` 内の各オブジェクトには `uuid`、`vector`、`properties`、`references`、`metadata`、`generated` といった複数の属性が含まれます。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START ResultDisplayOutput"
  endMarker="# END ResultDisplayOutput"
  language="bash"
/>

レスポンスのペイロードを制限するには、返すプロパティやメタデータを指定できます。

<!-- Additionally, to view the response object in a more readable format, you can use the `json.dumps()` function as shown below

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START ResultJSONDisplayExample"
  endMarker="# END ResultJSONDisplayExample"
  language="bash"
/>

This is the formatted output.

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START ResultJSONDisplayResults"
  endMarker="# END ResultJSONDisplayResults"
  language="bash"
/> -->

## 入力引数のバリデーション

クライアントライブラリは、デフォルトで入力引数の型が期待どおりであることを確認するバリデーションを行います。

パフォーマンスを向上させるために、このバリデーションを無効化できます。たとえばコレクションオブジェクトのインスタンス化時や `collections.get`、`collections.create` で `skip_argument_validation` パラメーターを `True` に設定します。

<FilteredTextBlock
  text={PythonCode}
  startMarker="# START SkipValidationExample"
  endMarker="# END SkipValidationExample"
  language="bash"
/>

これは、運用環境でクライアントライブラリを使用し、入力引数の型が正しいことを確信できる場合に便利です。

## Jupyter ノートブックでのタブ補完

ブラウザで Jupyter ノートブックを実行して Python クライアントを使用する場合、編集中に `Tab` キーを押すとコード補完が利用できます。VSCode で Jupyter ノートブックを実行している場合は、`control` + `space` でコード補完を呼び出せます。

## 生の GraphQL クエリ

生の GraphQL クエリを送信するには、`client.graphql_raw_query` メソッド（`v3` クライアントでは `client.query.raw`）を使用します。このメソッドは文字列を入力として受け取ります。

